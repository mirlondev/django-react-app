import React, { useState, useEffect, useRef, useCallback } from "react";
import {
  MessageSquare,
  User,
  Clock,
  Tag,
  ArrowLeft,
  Paperclip,
  Send,
  AlertCircle,
  CheckCircle,
  Clock as ClockIcon,
  XCircle,
  Eye,
  Trash2,
  Users,
  Wifi,
  WifiOff,
  Loader2,
  Image as ImageIcon,
  File,
  X,
  MessageCircle,
  Settings,
  Phone,
  Mail,
  Building,
  Calendar,
} from "lucide-react";
import { useParams, useNavigate } from "react-router-dom";
import AuthenticatedLayout from "../../components/Auth/AuthenticatedLayout";
import { useAuth } from "../../context/AuthContext";
import { interventionsAPI, ticketsAPI } from "../../services/api";
import toast from "react-hot-toast";

// ... (les interfaces restent les m√™mes)

const TicketReply: React.FC = () => {
  // ... (les √©tats et refs restent les m√™mes)

  // Nettoyer les IDs de message pour √©viter les doublons
  const cleanupMessageIds = useCallback(() => {
    if (messageIdsRef.current.size > 500) {
      const idsArray = Array.from(messageIdsRef.current);
      const recentIds = idsArray.slice(-400); // Garder les 400 plus r√©cents
      messageIdsRef.current = new Set(recentIds);
    }
  }, []);

  // Gestion am√©lior√©e des messages WebSocket
  const handleWebSocketMessage = useCallback((data: any) => {
    // Pr√©venir les messages dupliqu√©s
    if (data.id && messageIdsRef.current.has(data.id)) {
      return;
    }
    
    if (data.id) {
      messageIdsRef.current.add(data.id);
      cleanupMessageIds();
    }

    switch (data.type) {
      case "chat":
      case "message":
        // Ne pas afficher l'indicateur de frappe pour ses propres messages
        if (data.user_id === user?.id) {
          setTypingUsers(prev => {
            const updated = { ...prev };
            delete updated[data.user_id];
            return updated;
          });
        }

        const newChatMessage: ChatMessage = {
          id: data.id || `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          message: data.message,
          user_id: data.user_id,
          user_type: data.user_type,
          timestamp: data.timestamp || new Date().toISOString(),
          status: "sent",
          attachments: data.attachments || [],
        };

        setChatMessages((prev) => {
          // √âviter les messages en double
          const exists = prev.find((msg) => msg.id === newChatMessage.id);
          if (exists) return prev;
          
          // Mettre √† jour les messages temporaires avec les vrais IDs du serveur
          return prev.map(msg => 
            msg.status === "sending" && msg.message === newChatMessage.message && msg.user_id === newChatMessage.user_id
              ? newChatMessage
              : msg
          );
        });
        break;

      // ... (le reste du switch reste inchang√©)
    }
  }, [user, cleanupMessageIds]);

  // Configuration WebSocket am√©lior√©e avec gestion d'erreurs
  const setupWebSocket = useCallback(() => {
    if (!id || !user) return;

    // Nettoyer toute reconnexion pr√©c√©dente
    if (reconnectTimeoutRef.current) {
      clearTimeout(reconnectTimeoutRef.current);
    }

    const token = localStorage.getItem("accessToken") || sessionStorage.getItem("accessToken");
    if (!token) {
      console.error("‚ö†Ô∏è No JWT token found for WebSocket connection");
      toast.error("Authentication token missing. Please login again.");
      return;
    }

    // Fermer la connexion existante si elle existe
    if (wsRef.current) {
      wsRef.current.close(1000, "Reconnecting");
      wsRef.current = null;
    }

    setConnectionStatus("connecting");

    try {
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const websocket = new WebSocket(
        `${protocol}//${window.location.host}/ws/ticket/${id}/chat/?token=${encodeURIComponent(token)}`
      );

      wsRef.current = websocket;

      websocket.onopen = () => {
        console.log("‚úÖ WebSocket connected successfully");
        setConnectionStatus("connected");
        setReconnectAttempts(0);

        // Envoyer une notification de pr√©sence
        const presenceMessage = JSON.stringify({
          type: "user_online",
          user_id: user.id,
          user_name: `${user.first_name} ${user.last_name}`,
          user_type: user.userType,
        });
        
        if (websocket.readyState === WebSocket.OPEN) {
          websocket.send(presenceMessage);
        }

        toast.success("Connected to live chat", { duration: 2000 });
      };

      websocket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        } catch (error) {
          console.error("‚ùå Error parsing WebSocket message:", error);
        }
      };

      websocket.onclose = (event) => {
        console.log("‚ö†Ô∏è WebSocket disconnected:", event.code, event.reason);
        setConnectionStatus("disconnected");
        
        // Ne pas reconnecter si ferm√© normalement
        if (event.code === 1000) {
          console.log("WebSocket closed normally");
          return;
        }

        // Logique de reconnexion automatique avec backoff exponentiel
        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
          const delay = Math.min(
            BASE_RECONNECT_DELAY * Math.pow(2, reconnectAttempts),
            MAX_RECONNECT_DELAY
          );

          console.log(`üîÑ Reconnecting in ${delay}ms (attempt ${reconnectAttempts + 1}/${MAX_RECONNECT_ATTEMPTS})`);

          reconnectTimeoutRef.current = setTimeout(() => {
            setReconnectAttempts((prev) => prev + 1);
            setupWebSocket();
          }, delay);
        } else {
          toast.error("Unable to connect to live chat. Please refresh the page.");
        }
      };

      websocket.onerror = (error) => {
        console.error("‚ùå WebSocket error:", error);
        setConnectionStatus("disconnected");
      };
    } catch (error) {
      console.error("‚ùå Error creating WebSocket:", error);
      setConnectionStatus("disconnected");
      
      // R√©essayer apr√®s un d√©lai
      if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
        const delay = Math.min(
          BASE_RECONNECT_DELAY * Math.pow(2, reconnectAttempts),
          MAX_RECONNECT_DELAY
        );

        reconnectTimeoutRef.current = setTimeout(() => {
          setReconnectAttempts((prev) => prev + 1);
          setupWebSocket();
        }, delay);
      }
    }
  }, [id, user, reconnectAttempts, handleWebSocketMessage]);

  // Soumission de message am√©lior√©e
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validation am√©lior√©e de la connexion
    if (!newMessage.trim() || !ticket) {
      return;
    }
    
    if (!wsRef.current || wsRef.current.readyState !== WebSocket.OPEN) {
      toast.error("Connection lost. Please wait for reconnection.");
      return;
    }

    const tempId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const messagePayload = {
      id: tempId,
      type: "chat",
      message: newMessage.trim(),
      user_id: user?.id,
      user_type: user?.userType,
      timestamp: new Date().toISOString(),
      attachments: attachments.length > 0
        ? attachments.map((file) => ({
            id: `att_${Date.now()}_${file.name}`,
            name: file.name,
            type: file.type,
            size: file.size,
            url: URL.createObjectURL(file),
          }))
        : undefined,
    };

    // Ajouter le message imm√©diatement √† l'UI (mise √† jour optimiste)
    const optimisticMessage: ChatMessage = {
      ...messagePayload,
      status: "sending",
    };
    
    // Ajouter aux IDs de message pour √©viter les doublons
    messageIdsRef.current.add(tempId);
    cleanupMessageIds();
    
    setChatMessages((prev) => [...prev, optimisticMessage]);

    try {
      // Envoyer via WebSocket
      wsRef.current.send(JSON.stringify(messagePayload));

      // Si technicien/admin, √©galement enregistrer comme intervention
      if (user?.userType === "technician" || user?.userType === "admin") {
        setSubmitting(true);
        await interventionsAPI.create({
          ticket: ticket.id,
          report: newMessage.trim(),
        });

        // Actualiser les interventions
        const interventionsResponse = await interventionsAPI.getByTicketId(ticket.id);
        setInterventions(interventionsResponse.data.results || interventionsResponse.data);
      }

      // R√©initialiser le formulaire
      setNewMessage("");
      setAttachments([]);
      setSubmitting(false);
      messageInputRef.current?.focus();
    } catch (error) {
      console.error("‚ùå Error sending message:", error);
      toast.error("Failed to send message");

      // Mettre √† jour le statut du message en √©chec
      setChatMessages((prev) =>
        prev.map((msg) =>
          msg.id === tempId ? { ...msg, status: "failed" } : msg
        )
      );
    }
  };

  // Gestion am√©lior√©e de la frappe
  const handleTyping = useCallback(() => {
    if (!wsRef.current || wsRef.current.readyState !== WebSocket.OPEN || !user) return;

    if (!isTyping) {
      setIsTyping(true);
      try {
        wsRef.current.send(JSON.stringify({
          type: "typing",
          user_id: user.id,
          user_name: `${user.first_name} ${user.last_name}`,
        }));
      } catch (error) {
        console.error("Error sending typing indicator:", error);
      }
    }

    // Effacer le timeout pr√©c√©dent
    if (typingTimeoutRef.current) {
      clearTimeout(typingTimeoutRef.current);
    }

    // D√©finir un nouveau timeout
    typingTimeoutRef.current = setTimeout(() => {
      setIsTyping(false);
    }, 1000);
  }, [user, isTyping]);

  // Nettoyage am√©lior√© lors du d√©montage
  useEffect(() => {
    return () => {
      if (wsRef.current) {
        wsRef.current.close(1000, "Component unmounting");
        wsRef.current = null;
      }
      
      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current);
      }
      
      if (typingTimeoutRef.current) {
        clearTimeout(typingTimeoutRef.current);
      }
      
      // Lib√©rer les URLs des objets
      attachments.forEach((file) => {
        if (file instanceof File) {
          URL.revokeObjectURL(URL.createObjectURL(file));
        }
      });
    };
  }, [attachments]);

  // Filter messages based on current filter
  const getFilteredMessages = () => {
    const allMessages = [
      // Original description as first message
      {
        type: "original",
        id: "original",
        message: ticket?.description || "",
        user_id: ticket?.client.user.id || "",
        user_type: "client" as const,
        timestamp: ticket?.created_at || "",
        user_name: ticket ? `${ticket.client.user.first_name} ${ticket.client.user.last_name}` : ""
      },
      // Interventions
      ...interventions.map(intervention => ({
        type: "intervention",
        id: intervention.id,
        message: intervention.report,
        user_id: intervention.technician?.user.id || ticket?.client.user.id || "",
        user_type: intervention.technician ? "technician" as const : "client" as const,
        timestamp: intervention.created_at,
        user_name: intervention.technician 
          ? `${intervention.technician.user.first_name} ${intervention.technician.user.last_name}`
          : ticket ? `${ticket.client.user.first_name} ${ticket.client.user.last_name}` : "",
        attachments: intervention.attachments || []
      })),
      // Chat messages
      ...chatMessages.map(msg => ({
        type: "chat",
        ...msg,
        user_name: msg.user_type === "client" && ticket
          ? `${ticket.client.user.first_name} ${ticket.client.user.last_name}`
          : msg.user_type === "technician" && ticket?.technician
          ? `${ticket.technician.user.first_name} ${ticket.technician.user.last_name}`
          : "Support"
      }))
    ].sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());

    switch (messageFilter) {
      case "interventions":
        return allMessages.filter(msg => msg.type === "intervention" || msg.type === "original");
      case "chat":
        return allMessages.filter(msg => msg.type === "chat");
      default:
        return allMessages;
    }
  };

  // Render loading state
  if (loading) {
    return (
      <AuthenticatedLayout>
        <div className="min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 flex items-center justify-center">
          <div className="text-center">
            <Loader2 className="w-12 h-12 animate-spin mx-auto mb-4 text-blue-500" />
            <h2 className="text-xl font-semibold mb-2">Loading Ticket</h2>
            <p className="text-gray-500 dark:text-gray-400">Please wait while we fetch the ticket details...</p>
          </div>
        </div>
      </AuthenticatedLayout>
    );
  }

  // Render ticket not found
  if (!ticket) {
    return (
      <AuthenticatedLayout>
        <div className="min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 flex items-center justify-center">
          <div className="text-center">
            <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h1 className="text-2xl font-bold mb-4">Ticket Not Found</h1>
            <p className="text-gray-500 dark:text-gray-400 mb-6">
              The ticket you're looking for doesn't exist or you don't have permission to view it.
            </p>
            <button 
              onClick={() => navigate("/tickets")}
              className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              Back to Tickets
            </button>
          </div>
        </div>
      </AuthenticatedLayout>
    );
  }

  const filteredMessages = getFilteredMessages();
  const currentTypingUsers = Object.values(typingUsers).filter(
    user => user.user_id !== user?.id && Date.now() - user.timestamp < 3000
  );

  return (
    <AuthenticatedLayout>
      <div className="min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
        <div className="max-w-7xl mx-auto px-4 py-6">
          {/* Enhanced Header */}
          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4">
            <div className="flex items-center">
              <button 
                onClick={() => navigate("/tickets")}
                className="mr-4 p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                title="Back to tickets"
              >
                <ArrowLeft className="w-6 h-6" />
              </button>
              <div>
                <h1 className="text-3xl font-bold text-gray-900 dark:text-white">
                  Ticket #{ticket.id.substring(0, 8)}
                </h1>
                <p className="text-gray-600 dark:text-gray-400 mt-1">
                  Manage and respond to customer inquiries
                </p>
              </div>
            </div>

            {/* Connection Status & Online Users */}
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2 text-sm">
                {getConnectionStatusIndicator()}
                <span className={`font-medium ${
                  connectionStatus === "connected" 
                    ? "text-green-600 dark:text-green-400" 
                    : connectionStatus === "connecting"
                    ? "text-yellow-600 dark:text-yellow-400"
                    : "text-red-600 dark:text-red-400"
                }`}>
                  {connectionStatus === "connected" && "Connected"}
                  {connectionStatus === "connecting" && "Connecting..."}
                  {connectionStatus === "disconnected" && "Disconnected"}
                </span>
              </div>

              <button
                onClick={() => setShowOnlineUsers(!showOnlineUsers)}
                className="flex items-center gap-2 px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
              >
                <Users className="w-4 h-4" />
                <span className="text-sm font-medium">{Object.keys(onlineUsers).length}</span>
              </button>
            </div>
          </div>

          <div className="grid grid-cols-1 xl:grid-cols-4 gap-6">
            {/* Left Sidebar - Ticket Information */}
            <div className="xl:col-span-1 space-y-6">
              {/* Ticket Status Card */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <h2 className="text-lg font-semibold mb-4 flex items-center text-gray-900 dark:text-white">
                  <Tag className="w-5 h-5 mr-2" /> Status
                </h2>
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Current Status</span>
                    <div className="flex items-center gap-2">
                      {getStatusIcon(ticket.status)}
                      <span className="font-medium capitalize text-gray-900 dark:text-white">
                        {ticket.status.replace('_', ' ')}
                      </span>
                    </div>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Priority</span>
                    {getPriorityBadge(ticket.priority)}
                  </div>
                  <div className="pt-2 border-t border-gray-200 dark:border-gray-700">
                    <div className="flex items-center text-xs text-gray-500 dark:text-gray-400 mb-1">
                      <Calendar className="w-3 h-3 mr-1" />
                      Created: {formatDate(ticket.created_at)}
                    </div>
                    <div className="flex items-center text-xs text-gray-500 dark:text-gray-400">
                      <Clock className="w-3 h-3 mr-1" />
                      Updated: {formatDate(ticket.updated_at)}
                    </div>
                  </div>
                </div>
              </div>

              {/* Customer Information */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <h2 className="text-lg font-semibold mb-4 flex items-center text-gray-900 dark:text-white">
                  <User className="w-5 h-5 mr-2" /> Customer
                </h2>
                <div className="flex items-start space-x-3">
                  <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold text-lg">
                    {ticket.client.user.first_name.charAt(0)}{ticket.client.user.last_name.charAt(0)}
                  </div>
                  <div className="flex-1 min-w-0">
                    <h3 className="font-semibold text-gray-900 dark:text-white">
                      {ticket.client.user.first_name} {ticket.client.user.last_name}
                    </h3>
                    <div className="space-y-1 mt-2">
                      <div className="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <Mail className="w-3 h-3 mr-2" />
                        <span className="truncate">{ticket.client.user.email}</span>
                      </div>
                      {ticket.client.phone && (
                        <div className="flex items-center text-sm text-gray-600 dark:text-gray-400">
                          <Phone className="w-3 h-3 mr-2" />
                          <span>{ticket.client.phone}</span>
                        </div>
                      )}
                      {ticket.client.company && (
                        <div className="flex items-center text-sm text-gray-600 dark:text-gray-400">
                          <Building className="w-3 h-3 mr-2" />
                          <span>{ticket.client.company}</span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              {/* Technician Information */}
              {ticket.technician && (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                  <h2 className="text-lg font-semibold mb-4 flex items-center text-gray-900 dark:text-white">
                    <Settings className="w-5 h-5 mr-2" /> Assigned Technician
                  </h2>
                  <div className="flex items-start space-x-3">
                    <div className="w-12 h-12 bg-gradient-to-br from-green-500 to-teal-600 rounded-full flex items-center justify-center text-white font-semibold text-lg">
                      {ticket.technician.user.first_name.charAt(0)}{ticket.technician.user.last_name.charAt(0)}
                    </div>
                    <div className="flex-1 min-w-0">
                      <h3 className="font-semibold text-gray-900 dark:text-white">
                        {ticket.technician.user.first_name} {ticket.technician.user.last_name}
                      </h3>
                      <div className="space-y-1 mt-2">
                        <div className="flex items-center text-sm text-gray-600 dark:text-gray-400">
                          <Mail className="w-3 h-3 mr-2" />
                          <span className="truncate">{ticket.technician.user.email}</span>
                        </div>
                        {ticket.technician.phone && (
                          <div className="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <Phone className="w-3 h-3 mr-2" />
                            <span>{ticket.technician.phone}</span>
                          </div>
                        )}
                        <div className="flex items-center text-sm text-gray-600 dark:text-gray-400">
                          <Tag className="w-3 h-3 mr-2" />
                          <span className="capitalize">{ticket.technician.specialty}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Online Users Panel */}
              {showOnlineUsers && (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                  <h2 className="text-lg font-semibold mb-4 flex items-center text-gray-900 dark:text-white">
                    <Users className="w-5 h-5 mr-2" /> Online Users
                  </h2>
                  <div className="space-y-3">
                    {Object.values(onlineUsers).map((onlineUser) => (
                      <div key={onlineUser.user_id} className="flex items-center space-x-3">
                        <div className="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                          <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-medium text-gray-900 dark:text-white truncate">
                            {onlineUser.user_name}
                          </p>
                          <p className="text-xs text-gray-500 dark:text-gray-400 capitalize">
                            {onlineUser.user_type}
                          </p>
                        </div>
                      </div>
                    ))}
                    {Object.keys(onlineUsers).length === 0 && (
                      <p className="text-sm text-gray-500 dark:text-gray-400 text-center py-4">
                        No users currently online
                      </p>
                    )}
                  </div>
                </div>
              )}
            </div>

            {/* Main Content Area */}
            <div className="xl:col-span-3">
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                {/* Ticket Header */}
                <div className="border-b border-gray-200 dark:border-gray-700 p-6">
                  <div className="flex justify-between items-start mb-4">
                    <h2 className="text-2xl font-bold text-gray-900 dark:text-white pr-4">
                      {ticket.title}
                    </h2>
                    <div className="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                      <Clock className="w-4 h-4" />
                      <span>Last updated: {formatDate(ticket.updated_at)}</span>
                    </div>
                  </div>

                  {/* Attachments */}
                  {ticket.images && ticket.images.length > 0 && (
                    <div className="mt-4">
                      <h3 className="font-semibold mb-3 flex items-center text-gray-900 dark:text-white">
                        <Paperclip className="w-4 h-4 mr-2" />
                        Attachments ({ticket.images.length})
                      </h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                        {ticket.images.map((image) => (
                          <div key={image.id} className="group relative">
                            <div 
                              className="aspect-square bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                              onClick={() => setSelectedImage(image.image)}
                            >
                              <img 
                                src={image.image} 
                                alt={`Attachment ${image.id}`}
                                className="w-full h-full object-cover"
                              />
                            </div>
                            <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 rounded-lg flex items-center justify-center">
                              <Eye className="w-6 h-6 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-200" />
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* Chat Section */}
                <div className="flex flex-col h-[600px]">
                  {/* Message Filter Tabs */}
                  <div className="flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                    {[
                      { key: "all", label: "All Messages", icon: MessageSquare },
                      { key: "interventions", label: "Interventions", icon: Settings },
                      { key: "chat", label: "Live Chat", icon: MessageCircle }
                    ].map(({ key, label, icon: Icon }) => (
                      <button
                        key={key}
                        onClick={() => setMessageFilter(key as any)}
                        className={`flex items-center px-4 py-3 text-sm font-medium border-b-2 transition-colors ${
                          messageFilter === key
                            ? "border-blue-500 text-blue-600 dark:text-blue-400 bg-white dark:bg-gray-800"
                            : "border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
                        }`}
                      >
                        <Icon className="w-4 h-4 mr-2" />
                        {label}
                      </button>
                    ))}
                  </div>

                  {/* Messages Container */}
                  <div 
                    ref={chatContainerRef}
                    className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900/50"
                  >
                    {filteredMessages.map((message) => {
                      const isOwnMessage = message.user_id === user?.id;
                      const isClient = message.user_type === "client";
                      const isSystemMessage = message.type === "original";
                      
                      return (
                        <div
                          key={message.id}
                          className={`flex ${isOwnMessage && !isSystemMessage ? "justify-end" : "justify-start"}`}
                        >
                          <div className={`flex max-w-[80%] ${
                            isOwnMessage && !isSystemMessage ? "flex-row-reverse" : "flex-row"
                          }`}>
                            {/* Avatar */}
                            <div className="flex-shrink-0">
                              <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold text-white ${
                                isSystemMessage
                                  ? "bg-gray-500"
                                  : isClient
                                  ? "bg-blue-500"
                                  : message.user_type === "technician"
                                  ? "bg-green-500"
                                  : "bg-purple-500"
                              }`}>
                                {isSystemMessage
                                  ? <File className="w-5 h-5" />
                                  : message.user_name
                                  ? message.user_name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2)
                                  : <User className="w-5 h-5" />
                                }
                              </div>
                            </div>

                            {/* Message Content */}
                            <div className={`${isOwnMessage && !isSystemMessage ? "mr-3" : "ml-3"} min-w-0 flex-1`}>
                              <div className={`p-4 rounded-2xl ${
                                isSystemMessage
                                  ? "bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600"
                                  : isOwnMessage
                                  ? "bg-blue-500 text-white"
                                  : isClient
                                  ? "bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700"
                                  : "bg-green-100 dark:bg-green-900/30 text-green-900 dark:text-green-100"
                              }`}>
                                {isSystemMessage && (
                                  <div className="flex items-center mb-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                                    <File className="w-4 h-4 mr-2" />
                                    Original Description
                                  </div>
                                )}
                                <p className="text-sm leading-relaxed whitespace-pre-wrap">
                                  {message.message}
                                </p>
                                
                                {/* Message Status */}
                                {message.status && message.status !== "sent" && (
                                  <div className="flex items-center mt-2 text-xs opacity-75">
                                    {message.status === "sending" && <Loader2 className="w-3 h-3 animate-spin mr-1" />}
                                    {message.status === "failed" && <XCircle className="w-3 h-3 mr-1" />}
                                    <span className="capitalize">{message.status}</span>
                                  </div>
                                )}
                                
                                {/* Attachments */}
                                {message.attachments && message.attachments.length > 0 && (
                                  <div className="mt-3 space-y-2">
                                    {message.attachments.map((attachment, index) => (
                                      <div key={index} className="flex items-center gap-2 p-2 bg-white/10 rounded-lg">
                                        {attachment.type.startsWith('image/') ? (
                                          <ImageIcon className="w-4 h-4" />
                                        ) : (
                                          <File className="w-4 h-4" />
                                        )}
                                        <span className="text-xs truncate">{attachment.name}</span>
                                        <span className="text-xs opacity-75">({formatFileSize(attachment.size)})</span>
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>

                              {/* Message Footer */}
                              <div className={`flex items-center mt-2 text-xs text-gray-500 dark:text-gray-400 gap-2 ${
                                isOwnMessage && !isSystemMessage ? "justify-end" : "justify-start"
                              }`}>
                                <span className="font-medium">{message.user_name}</span>
                                <span>‚Ä¢</span>
                                <span>{formatDate(message.timestamp)}</span>
                                {message.type === "intervention" && (
                                  <>
                                    <span>‚Ä¢</span>
                                    <span className="flex items-center gap-1">
                                      <Settings className="w-3 h-3" />
                                      Intervention
                                    </span>
                                  </>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })}

                    {/* Typing Indicators */}
                    {currentTypingUsers.length > 0 && (
                      <div className="flex justify-start">
                        <div className="flex items-center space-x-3">
                          <div className="w-10 h-10 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center">
                            <div className="flex space-x-1">
                              <div className="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                              <div className="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                            </div>
                          </div>
                          <div className="bg-gray-200 dark:bg-gray-700 rounded-2xl px-4 py-2">
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                              {currentTypingUsers.length === 1
                                ? `${currentTypingUsers[0].user_name} is typing...`
                                : `${currentTypingUsers.length} people are typing...`
                              }
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div ref={messagesEndRef} />
                  </div>

                  {/* Message Input */}
                  <div className="border-t border-gray-200 dark:border-gray-700 p-4 bg-white dark:bg-gray-800">
                    {/* Attachment Preview */}
                    {attachments.length > 0 && (
                      <div className="mb-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-sm font-medium text-gray-700 dark:text-gray-300">
                            Attachments ({attachments.length})
                          </span>
                          <button
                            onClick={() => setAttachments([])}
                            className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                          >
                            <X className="w-4 h-4" />
                          </button>
                        </div>
                        <div className="space-y-2">
                          {attachments.map((file, index) => (
                            <div key={index} className="flex items-center justify-between p-2 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-600">
                              <div className="flex items-center gap-2 flex-1 min-w-0">
                                {file.type.startsWith('image/') ? (
                                  <ImageIcon className="w-4 h-4 text-gray-500" />
                                ) : (
                                  <File className="w-4 h-4 text-gray-500" />
                                )}
                                <span className="text-sm truncate">{file.name}</span>
                                <span className="text-xs text-gray-500">({formatFileSize(file.size)})</span>
                              </div>
                              <button
                                onClick={() => removeAttachment(index)}
                                className="ml-2 text-red-500 hover:text-red-700"
                              >
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Input Form */}
                    <form onSubmit={handleSubmit} className="space-y-4">
                      <div className="flex items-end gap-3">
                        <div className="flex-1">
                          <textarea
                            ref={messageInputRef}
                            rows={3}
                            value={newMessage}
                            onChange={(e) => {
                              setNewMessage(e.target.value);
                              handleTyping();
                            }}
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                handleSubmit(e);
                              }
                            }}
                            className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white resize-none"
                            placeholder="Type your message... (Press Enter to send, Shift+Enter for new line)"
                            disabled={connectionStatus !== "connected"}
                          />
                        </div>
                        <div className="flex flex-col gap-2">
                          <input 
                            ref={fileInputRef}
                            type="file" 
                            id="attachment" 
                            className="hidden" 
                            multiple 
                            accept="image/*,application/pdf,.doc,.docx,.txt"
                            onChange={handleAttachment} 
                          />
                          <button
                            type="button"
                            onClick={() => fileInputRef.current?.click()}
                            className="p-3 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-colors"
                            title="Attach files"
                          >
                            <Paperclip className="w-5 h-5" />
                          </button>
                          <button 
                            type="submit" 
                            className="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center" 
                            disabled={!newMessage.trim() || submitting || connectionStatus !== "connected"}
                            title={connectionStatus !== "connected" ? "Connection required" : "Send message"}
                          >
                            {submitting ? (
                              <Loader2 className="w-5 h-5 animate-spin" />
                            ) : (
                              <Send className="w-5 h-5" />
                            )}
                          </button>
                        </div>
                      </div>
                      
                      {connectionStatus !== "connected" && (
                        <div className="flex items-center gap-2 text-sm text-amber-600 dark:text-amber-400">
                          <AlertCircle className="w-4 h-4" />
                          <span>
                            {connectionStatus === "connecting" 
                              ? "Connecting to live chat..." 
                              : "Disconnected from live chat. Messages cannot be sent."
                            }
                          </span>
                        </div>
                      )}
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Image Modal */}
        {selectedImage && (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="relative max-w-4xl max-h-full">
              <button
                onClick={() => setSelectedImage(null)}
                className="absolute -top-10 right-0 text-white hover:text-gray-300 z-10"
              >
                <X className="w-8 h-8" />
              </button>
              <img 
                src={selectedImage}
                alt="Full size attachment"
                className="max-w-full max-h-full object-contain rounded-lg"
              />
            </div>
          </div>
        )}
      </div>
    </AuthenticatedLayout>
  );
};

export default TicketReply;